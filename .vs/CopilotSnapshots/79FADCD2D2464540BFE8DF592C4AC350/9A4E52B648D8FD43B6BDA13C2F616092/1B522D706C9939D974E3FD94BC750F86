using System.Text.Json;
using Microsoft.Maui.Storage;
using SecretSanta2.Models;

namespace SecretSanta2.Services
{
    public class DrawStorageService
    {
        private readonly string _filePath;
        private readonly JsonSerializerOptions _jsonOptions = new(JsonSerializerDefaults.General)
        {
            WriteIndented = true,
            PropertyNameCaseInsensitive = true
        };

        public DrawStorageService()
        {
            _filePath = Path.Combine(FileSystem.AppDataDirectory, "draws.json");
        }

        public async Task<IList<SecretSantaDraw>> LoadAllAsync()
        {
            try
            {
                if (!File.Exists(_filePath)) return new List<SecretSantaDraw>();
                await using var fs = File.OpenRead(_filePath);
                var list = await JsonSerializer.DeserializeAsync<List<SecretSantaDraw>>(fs, _jsonOptions);
                return list ?? new List<SecretSantaDraw>();
            }
            catch
            {
                return new List<SecretSantaDraw>();
            }
        }

        public async Task SaveAsync(SecretSantaDraw draw)
        {
            var all = (await LoadAllAsync()).ToList();
            var existing = all.FindIndex(d => string.Equals(d.Name, draw.Name, StringComparison.OrdinalIgnoreCase));
            if (existing >= 0) all[existing] = draw; else all.Add(draw);
            Directory.CreateDirectory(Path.GetDirectoryName(_filePath)!);
            await using var fs = File.Create(_filePath);
            await JsonSerializer.SerializeAsync(fs, all, _jsonOptions);
        }

        public async Task<SecretSantaDraw?> LoadByNameAsync(string name)
        {
            var all = await LoadAllAsync();
            return all.FirstOrDefault(d => string.Equals(d.Name, name, StringComparison.OrdinalIgnoreCase));
        }

        public async Task DeleteAsync(string name)
        {
            var all = (await LoadAllAsync()).ToList();
            all.RemoveAll(d => string.Equals(d.Name, name, StringComparison.OrdinalIgnoreCase));
            await using var fs = File.Create(_filePath);
            await JsonSerializer.SerializeAsync(fs, all, _jsonOptions);
        }

        public async Task<IList<string>> ListNamesAsync()
        {
            var all = await LoadAllAsync();
            return all.Select(d => d.Name).OrderBy(n => n).ToList();
        }
    }
}