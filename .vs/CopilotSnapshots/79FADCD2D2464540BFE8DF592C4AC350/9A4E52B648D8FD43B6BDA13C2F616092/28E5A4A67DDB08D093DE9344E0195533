using System.Text.Json;
using Microsoft.Maui.Storage;
using SecretSanta2.Models;

namespace SecretSanta2.Services
{
    public class DrawStorageService
    {
        private readonly string _filePath = Path.Combine(FileSystem.AppDataDirectory, "draws.json");
        private readonly JsonSerializerOptions _opts = new(JsonSerializerDefaults.General) { WriteIndented = true, PropertyNameCaseInsensitive = true };

        public async Task<IList<SecretSantaDraw>> LoadAllAsync()
        {
            if (!File.Exists(_filePath)) return new List<SecretSantaDraw>();
            await using var fs = File.OpenRead(_filePath);
            return await JsonSerializer.DeserializeAsync<List<SecretSantaDraw>>(fs, _opts) ?? new List<SecretSantaDraw>();
        }

        public async Task SaveAsync(SecretSantaDraw draw)
        {
            var all = (await LoadAllAsync()).ToList();
            var idx = all.FindIndex(d => string.Equals(d.Name, draw.Name, StringComparison.OrdinalIgnoreCase));
            if (idx >= 0) all[idx] = draw; else all.Add(draw);
            Directory.CreateDirectory(Path.GetDirectoryName(_filePath)!);
            await using var fs = File.Create(_filePath);
            await JsonSerializer.SerializeAsync(fs, all, _opts);
        }

        public async Task<SecretSantaDraw?> LoadByNameAsync(string name)
        {
            var all = await LoadAllAsync();
            return all.FirstOrDefault(d => string.Equals(d.Name, name, StringComparison.OrdinalIgnoreCase));
        }

        public async Task DeleteAsync(string name)
        {
            var all = (await LoadAllAsync()).ToList();
            all.RemoveAll(d => string.Equals(d.Name, name, StringComparison.OrdinalIgnoreCase));
            await using var fs = File.Create(_filePath);
            await JsonSerializer.SerializeAsync(fs, all, _opts);
        }

        public async Task<IList<string>> ListNamesAsync()
        {
            var all = await LoadAllAsync();
            return all.Select(d => d.Name).OrderBy(n => n).ToList();
        }
    }
}